<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PUZZLE BATTLE ULTIMATE - LUNATIC</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#111;color:#fff;font-family:sans-serif;overflow:hidden}
#top{display:flex;justify-content:space-between;padding:6px;background:#222}
.bar{width:110px;height:10px;background:#333;border-radius:10px;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(to right,#0f0,#6f6)}
#enemyBar>div{background:linear-gradient(to right,#f33,#a00)}

#board{width:95vw;max-width:420px;height:360px;margin:auto;
display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(5,1fr);gap:4px}

.orb{
border-radius:50%;
opacity:.85;
box-shadow:inset -4px -4px 8px rgba(0,0,0,.4),
inset 3px 3px 6px rgba(255,255,255,.3);
}

.fire{background:radial-gradient(circle,#ffaaaa,#f33)}
.water{background:radial-gradient(circle,#aaf,#36f)}
.wood{background:radial-gradient(circle,#afa,#3f6)}
.light{background:radial-gradient(circle,#fff799,#ff0)}
.dark{background:radial-gradient(circle,#d5b3ff,#63f)}

#turnText{
position:fixed;top:40%;width:100%;
text-align:center;font-size:42px;
opacity:0;transition:.3s;
pointer-events:none;
}

.turn-player{color:#6cf;text-shadow:0 0 20px #6cf}
.turn-enemy{color:#f44;text-shadow:0 0 20px #f44}

#result{position:fixed;inset:0;background:#000c;display:none;
align-items:center;justify-content:center;text-align:center}

button{padding:10px 16px;border:none;border-radius:20px;background:#333;color:#fff}

#menu{position:fixed;inset:0;background:#000e;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center}

</style>
</head>
<body>

<div id="menu">
<h2>Èõ£ÊòìÂ∫¶„ÇíÈÅ∏Êäû</h2>
<button onclick="startGame('easy')">EASY</button>
<button onclick="startGame('normal')">NORMAL</button>
<button onclick="startGame('hard')">HARD</button>
<button onclick="startGame('lunatic')" style="background:#a00">üî• LUNATIC</button>
</div>

<div id="top">
<div>HP<div class="bar"><div id="hp"></div></div></div>
<div id="stage">STAGE 1</div>
<div>ENEMY<div class="bar" id="enemyBar"><div id="enemy"></div></div></div>
</div>

<div id="turnText"></div>
<div id="board"></div>

<div id="result">
<div>
<h2 id="resultText"></h2>
<button onclick="location.reload()">RETRY</button>
</div>
</div>

<script>
const ROW=5,COL=6;
const colors=["fire","water","wood","light","dark"];
let board=[],stage=1,playerHP=100,enemyHP=100;
let difficulty="normal",timer=0,turn=true;

const difficultyData={
easy:{hp:1,time:20,atk:0.7},
normal:{hp:1,time:15,atk:1},
hard:{hp:1.3,time:12,atk:1.4},
lunatic:{hp:2,time:7,atk:2}
};

let enemy={};

function startGame(diff){
difficulty=diff;
document.getElementById("menu").style.display="none";
init();
}

function init(){
playerHP=100;
stage=1;
newEnemy();
initBoard();
updateUI();
startTurn();
}

function initBoard(){
board=[];
for(let r=0;r<ROW;r++){
board[r]=[];
for(let c=0;c<COL;c++){
board[r][c]=colors[Math.floor(Math.random()*5)];
}
}
draw();
}

function newEnemy(){
if(difficulty==="lunatic"){
enemy={
name:"CHAOS CORE",
hp:999+stage*200,
absorb:"fire",
reflect:"water",
nullify:"wood",
weak:"light"
};
}else{
enemy={
name:"ENEMY",
hp:100+stage*50,
absorb:colors[Math.floor(Math.random()*5)],
reflect:colors[Math.floor(Math.random()*5)],
nullify:colors[Math.floor(Math.random()*5)],
weak:colors[Math.floor(Math.random()*5)]
};
}
enemyHP=enemy.hp;
}

function draw(){
const b=document.getElementById("board");
b.innerHTML="";
for(let r=0;r<ROW;r++)for(let c=0;c<COL;c++){
const d=document.createElement("div");
d.className="orb "+board[r][c];
d.dataset.r=r;d.dataset.c=c;
b.appendChild(d);
}
}

let dragging=false,last=null;

document.addEventListener("pointerdown",e=>{
if(!e.target.classList.contains("orb"))return;
dragging=true;
last={r:+e.target.dataset.r,c:+e.target.dataset.c};
});
document.addEventListener("pointermove",e=>{
if(!dragging)return;
const t=document.elementFromPoint(e.clientX,e.clientY);
if(!t||!t.classList.contains("orb"))return;
let r=+t.dataset.r,c=+t.dataset.c;
if(Math.abs(r-last.r)+Math.abs(c-last.c)==1){
[board[r][c],board[last.r][last.c]]=[board[last.r][last.c],board[r][c]];
last={r,c};
draw();
}
});
document.addEventListener("pointerup",()=>{dragging=false;check();});

function check(){
let del=[];
for(let r=0;r<ROW;r++)for(let c=0;c<COL-2;c++)
if(board[r][c]==board[r][c+1]&&board[r][c]==board[r][c+2])
del.push([r,c],[r,c+1],[r,c+2]);

for(let c=0;c<COL;c++)for(let r=0;r<ROW-2;r++)
if(board[r][c]==board[r+1][c]&&board[r][c]==board[r+2][c])
del.push([r,c],[r+1,c],[r+2,c]);

if(!del.length)return;

let dmg=del.length*5;
let type=board[del[0][0]][del[0][1]];

if(type===enemy.absorb)dmg*=-1;
if(type===enemy.reflect)dmg*=-2;
if(type===enemy.nullify)dmg=0;
if(type===enemy.weak)dmg*=2;

enemyHP-=dmg;
fall();
updateUI();

if(enemyHP<=0){
stage++;
newEnemy();
}
}

function fall(){
for(let c=0;c<COL;c++){
for(let r=ROW-1;r>=0;r--){
if(!board[r][c]){
for(let rr=r-1;rr>=0;rr--){
if(board[rr][c]){
board[r][c]=board[rr][c];
board[rr][c]=null;
break;
}
}
if(!board[r][c])board[r][c]=colors[Math.floor(Math.random()*5)];
}
}
}
draw();
}

function startTurn(){
showTurn("YOUR TURN");
timer=setTimeout(()=>enemyTurn(),difficultyData[difficulty].time*1000);
}

function enemyTurn(){
showTurn("ENEMY TURN");
playerHP-=Math.floor(10*difficultyData[difficulty].atk+stage*2);
updateUI();
if(playerHP<=0){
document.getElementById("result").style.display="flex";
document.getElementById("resultText").textContent="GAME OVER";
}else startTurn();
}

function showTurn(t){
const el=document.getElementById("turnText");
el.textContent=t;
el.style.opacity=1;
setTimeout(()=>el.style.opacity=0,700);
}

function updateUI(){
document.getElementById("hp").style.width=Math.max(playerHP,0)+"%";
document.getElementById("enemy").style.width=Math.max(enemyHP/enemy.hp*100,0)+"%";
document.getElementById("stage").textContent="STAGE "+stage;
}
</script>
</body>
</html>
