<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PUZZLE BATTLE ULTIMATE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body{margin:0;background:#111;color:#fff;font-family:sans-serif;overflow:hidden}
#top{display:flex;justify-content:space-between;padding:6px;background:#222;font-size:12px}
.bar{width:110px;height:10px;background:#333;border-radius:10px;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(to right,#0f0,#6f6)}
#enemyBar>div{background:linear-gradient(to right,#f33,#a00)}

#enemyInfo span{padding:2px 5px;border-radius:6px;margin:1px;font-size:11px}

#board{
  width:95vw;max-width:420px;height:360px;
  margin:auto;
  display:grid;
  grid-template-columns:repeat(6,1fr);
  grid-template-rows:repeat(5,1fr);
  gap:4px
}

.orb{
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  text-shadow:0 0 6px #000;
  transition:.2s;
}

.fire{background:#f44}
.water{background:#48f}
.wood{background:#4f4}
.light{background:#ff4}
.dark{background:#a6f}

#ui{display:flex;justify-content:space-around;padding:6px}
button{padding:6px 12px;border:none;border-radius:20px;background:#333;color:#fff}
button:disabled{opacity:.4}

#combo{position:fixed;top:55px;left:10px;font-size:22px;color:#ffd}

#menu,#result{
position:fixed;inset:0;
background:#000e;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
}

#result{display:none}

.effect{
  position:fixed;
  pointer-events:none;
  font-size:40px;
  animation:pop .6s ease-out forwards;
}
@keyframes pop{
  0%{transform:scale(.5);opacity:0}
  50%{transform:scale(1.4);opacity:1}
  100%{transform:scale(2);opacity:0}
}
.fireFX{color:#ff5533}
.waterFX{color:#55ccff}
.woodFX{color:#55ff55}
.lightFX{color:#ffff88}
.darkFX{color:#aa66ff}
</style>
</head>

<body>

<div id="menu">
<h2>PUZZLE BATTLE</h2>
<button onclick="start()">START</button>
<button onclick="loadGame()">LOAD</button>
<button onclick="clearSave()">DELETE SAVE</button>
</div>

<div id="top">
<div>HP<div class="bar"><div id="hp"></div></div></div>
<div id="stage">STAGE 1</div>
<div>
<div class="bar" id="enemyBar"><div id="enemy"></div></div>
<div id="enemyInfo"></div>
</div>
</div>

<div id="ui">
<button onclick="useSkill(1)">SKILL1</button>
<button onclick="useSkill(2)">SKILL2</button>
<button onclick="useSkill(3)">SKILL3</button>
</div>

<div id="combo"></div>
<div id="board"></div>

<div id="result">
<h2 id="resText"></h2>
<p id="scoreText"></p>
<button onclick="retry()">RETRY</button>
<button onclick="location.reload()">TITLE</button>
</div>

<script>
const R=5,C=6;
const colors=["fire","water","wood","light","dark"];
const icons={fire:"üî•",water:"üíß",wood:"üåø",light:"‚ú®",dark:"üåë"};
const effects={
 fire:"fireFX",water:"waterFX",wood:"woodFX",light:"lightFX",dark:"darkFX"
};

let board=[],hp=100,enemyHP=100,stage=1,combo=0,maxCombo=0,score=0;
let enemy={},cool=[0,0,0];

function start(){
document.getElementById("menu").style.display="none";
document.getElementById("result").style.display="none";
hp=100;stage=1;score=0;maxCombo=0;
newEnemy();makeBoard();update();
}

function rand(){return colors[Math.floor(Math.random()*5)];}

function newEnemy(){
enemy={
hp:200+stage*80,
atk:10+stage*2,
absorb:rand(),
reflect:rand(),
null:rand(),
weak:rand()
};
enemyHP=enemy.hp;
enemyInfo.innerHTML=
`<span>Âê∏:${icons[enemy.absorb]}</span>
<span>Âèç:${icons[enemy.reflect]}</span>
<span>ÁÑ°:${icons[enemy.null]}</span>
<span>Âº±:${icons[enemy.weak]}</span>`;
}

function makeBoard(){
board=[];
for(let r=0;r<R;r++){
board[r]=[];
for(let c=0;c<C;c++)board[r][c]=rand();
}
draw();
}

function draw(){
boardDiv.innerHTML="";
for(let r=0;r<R;r++)for(let c=0;c<C;c++){
let d=document.createElement("div");
d.className="orb "+board[r][c];
d.textContent=icons[board[r][c]];
d.dataset.r=r; d.dataset.c=c;
boardDiv.appendChild(d);
}
}

const boardDiv=document.getElementById("board");

let drag=null;
document.addEventListener("pointerdown",e=>{
if(e.target.classList.contains("orb"))drag=e.target;
});
document.addEventListener("pointermove",e=>{
if(!drag)return;
let t=document.elementFromPoint(e.clientX,e.clientY);
if(!t||!t.classList.contains("orb"))return;
let r1=+drag.dataset.r,c1=+drag.dataset.c;
let r2=+t.dataset.r,c2=+t.dataset.c;
if(Math.abs(r1-r2)+Math.abs(c1-c2)==1){
[board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]];
drag=t; draw();
}
});
document.addEventListener("pointerup",()=>{drag=null;resolve();});

function showEffect(type){
const e=document.createElement("div");
e.className="effect "+effects[type];
e.textContent=icons[type];
e.style.left="50%";
e.style.top="45%";
document.body.appendChild(e);
setTimeout(()=>e.remove(),600);
}

function resolve(){
let hit=[];
for(let r=0;r<R;r++)for(let c=0;c<C-2;c++)
if(board[r][c]==board[r][c+1]&&board[r][c]==board[r][c+2])
hit.push([r,c],[r,c+1],[r,c+2]);

if(!hit.length){enemyTurn();return;}

combo++; maxCombo=Math.max(maxCombo,combo);
document.getElementById("combo").textContent=combo+" COMBO";

let type=board[hit[0][0]][hit[0][1]];
let dmg=hit.length*5*(1+combo*0.3);

if(type==enemy.absorb)dmg*=-1;
if(type==enemy.reflect)dmg*=-1.5;
if(type==enemy.null)dmg=0;
if(type==enemy.weak)dmg*=2;

enemyHP-=Math.floor(dmg);
score+=Math.max(0,Math.floor(dmg));

showEffect(type);
setTimeout(()=>fall(),200);
}

function fall(){
for(let c=0;c<C;c++){
for(let r=R-1;r>=0;r--){
if(!board[r][c]){
for(let rr=r-1;rr>=0;rr--){
if(board[rr][c]){
board[r][c]=board[rr][c];
board[rr][c]=null;
break;
}}
if(!board[r][c])board[r][c]=rand();
}}
draw();
setTimeout(()=>resolve(),200);
}

function enemyTurn(){
combo=0;
hp-=enemy.atk;
if(hp<=0){gameOver();return;}
update();
}

function update(){
document.getElementById("hp").style.width=Math.max(hp,0)+"%";
document.getElementById("enemy").style.width=Math.max(enemyHP/enemy.hp*100,0)+"%";
document.getElementById("stage").textContent="STAGE "+stage;
if(enemyHP<=0){stage++;newEnemy();}
save();
}

function gameOver(){
save();
document.getElementById("resText").textContent="GAME OVER";
document.getElementById("scoreText").textContent=
`SCORE:${score} / MAX COMBO:${maxCombo} / STAGE:${stage}`;
document.getElementById("result").style.display="flex";
}

function useSkill(n){
if(n==1)enemyHP-=60;
if(n==2)hp=Math.min(100,hp+30);
if(n==3){
for(let r=0;r<R;r++)for(let c=0;c<C;c++)
if(board[r][c]==enemy.reflect)board[r][c]=enemy.weak;
}
update();
}

function save(){
localStorage.setItem("puzzleSave",JSON.stringify({
hp,stage,enemyHP,score,maxCombo
}));
}

function loadGame(){
let d=JSON.parse(localStorage.getItem("puzzleSave"));
if(!d)return alert("„Çª„Éº„Éñ„Å™„Åó");
({hp,stage,enemyHP,score,maxCombo}=d);
document.getElementById("menu").style.display="none";
newEnemy();update();
}

function clearSave(){
localStorage.removeItem("puzzleSave");
alert("ÂâäÈô§„Åó„Åæ„Åó„Åü");
}

function retry(){location.reload();}
</script>
</body>
</html>
