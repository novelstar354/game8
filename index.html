<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PUZZLE BATTLE ULTIMATE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;background:#111;color:#fff;font-family:sans-serif;overflow:hidden}
#top{display:flex;justify-content:space-between;padding:6px;background:#222;font-size:12px}
.bar{width:110px;height:10px;background:#333;border-radius:10px;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(to right,#0f0,#6f6)}
#enemyBar>div{background:linear-gradient(to right,#f33,#a00)}

#enemyInfo span{padding:2px 5px;border-radius:6px;margin:1px;font-size:11px}
.absorb{background:#0ff;color:#000}
.reflect{background:#f55}
.null{background:#aaa;color:#000}
.weak{background:#ff0;color:#000}

#board{width:95vw;max-width:420px;height:360px;margin:auto;
display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(5,1fr);gap:4px}
.orb{border-radius:50%;transition:.25s;box-shadow:inset -3px -3px 6px #0008,inset 3px 3px 6px #fff3}
.fire{background:#f44}.water{background:#48f}.wood{background:#4f4}.light{background:#ff4}.dark{background:#a6f}

#ui{display:flex;justify-content:space-around;padding:6px}
button{padding:6px 12px;border:none;border-radius:20px;background:#333;color:#fff}
button:disabled{opacity:.4}

#combo{position:fixed;top:60px;left:10px;font-size:22px;color:#ffd}
#damage{position:fixed;font-size:26px;color:#ff6666;pointer-events:none}
#turn{position:fixed;top:40%;width:100%;text-align:center;font-size:40px;opacity:0;transition:.4s}

#menu,#result{position:fixed;inset:0;background:#000d;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hidden{display:none}
</style>
</head>
<body>

<div id="menu">
<h2>PUZZLE BATTLE</h2>
<button onclick="start('easy')">EASY</button>
<button onclick="start('normal')">NORMAL</button>
<button onclick="start('hard')">HARD</button>
<button onclick="start('lunatic')" style="background:#a00">LUNATIC</button>
<button onclick="loadGame()">LOAD</button>
<button onclick="clearSave()">DELETE SAVE</button>
</div>

<div id="top">
<div>HP<div class="bar"><div id="hp"></div></div></div>
<div id="stage">STAGE 1</div>
<div>
<div class="bar" id="enemyBar"><div id="enemy"></div></div>
<div id="enemyInfo"></div>
</div>
</div>

<div id="ui">
<button id="s1" onclick="useSkill(1)">SKILL1</button>
<button id="s2" onclick="useSkill(2)">SKILL2</button>
<button id="s3" onclick="useSkill(3)">SKILL3</button>
</div>

<div id="combo"></div>
<div id="turn"></div>
<div id="board"></div>

<div id="result" class="hidden">
<h2 id="resText"></h2>
<button onclick="retry()">RETRY</button>
<button onclick="location.reload()">TITLE</button>
</div>

<script>
const R=5,C=6,colors=["fire","water","wood","light","dark"];
let board=[],hp=100,enemyHP=100,stage=1,combo=0;
let diff="normal",cool=[0,0,0];

function start(d){
diff=d;
document.getElementById("menu").style.display="none";
document.getElementById("result").classList.add("hidden");
newEnemy();makeBoard();update();
}

function newEnemy(){
enemy={
hp:200+stage*60,
absorb:colors[Math.random()*5|0],
reflect:colors[Math.random()*5|0],
null:colors[Math.random()*5|0],
weak:colors[Math.random()*5|0]
};
enemyHP=enemy.hp;
updateEnemyInfo();
}

function updateEnemyInfo(){
document.getElementById("enemyInfo").innerHTML=
`<span class="absorb">吸:${enemy.absorb}</span>
<span class="reflect">反:${enemy.reflect}</span>
<span class="null">無:${enemy.null}</span>
<span class="weak">弱:${enemy.weak}</span>`;
}

function makeBoard(){
board=[];
for(let r=0;r<R;r++){board[r]=[];
for(let c=0;c<C;c++)board[r][c]=colors[Math.random()*5|0];}
draw();
}

function draw(){
const b=document.getElementById("board");b.innerHTML="";
for(let r=0;r<R;r++)for(let c=0;c<C;c++){
let d=document.createElement("div");
d.className="orb "+board[r][c];
d.dataset.r=r;d.dataset.c=c;
b.appendChild(d);
}
}

let drag=null;
document.addEventListener("pointerdown",e=>{
if(e.target.classList.contains("orb"))drag=e.target;
});
document.addEventListener("pointermove",e=>{
if(!drag)return;
let t=document.elementFromPoint(e.clientX,e.clientY);
if(!t||!t.classList.contains("orb"))return;
let r1=+drag.dataset.r,c1=+drag.dataset.c;
let r2=+t.dataset.r,c2=+t.dataset.c;
if(Math.abs(r1-r2)+Math.abs(c1-c2)==1){
[board[r1][c1],board[r2][c2]]=[board[r2][c2],board[r1][c1]];
drag=t;draw();
}
});
document.addEventListener("pointerup",()=>{drag=null;resolve();});

function resolve(){
let hit=[];
for(let r=0;r<R;r++)for(let c=0;c<C-2;c++)
if(board[r][c]==board[r][c+1]&&board[r][c]==board[r][c+2])
hit.push([r,c],[r,c+1],[r,c+2]);
if(!hit.length)return;

combo++;
document.getElementById("combo").textContent=combo+" COMBO!";
setTimeout(()=>document.getElementById("combo").textContent="",600);

let type=board[hit[0][0]][hit[0][1]];
let dmg=hit.length*5*(1+combo*0.3);

if(type==enemy.absorb)dmg*=-1;
if(type==enemy.reflect)dmg*=-1.5;
if(type==enemy.null)dmg=0;
if(type==enemy.weak)dmg*=2;

enemyHP-=Math.floor(dmg);
showDamage(dmg);

setTimeout(()=>fall(),200);
}

function fall(){
for(let c=0;c<C;c++){
for(let r=R-1;r>=0;r--){
if(!board[r][c]){
for(let rr=r-1;rr>=0;rr--){
if(board[rr][c]){
board[r][c]=board[rr][c];
board[rr][c]=null;
break;
}}
if(!board[r][c])board[r][c]=colors[Math.random()*5|0];
}}
draw();
setTimeout(()=>resolve(),200);
}

function showDamage(d){
let e=document.createElement("div");
e.id="damage";e.textContent=Math.floor(d);
e.style.left="50%";e.style.top="45%";
document.body.appendChild(e);
setTimeout(()=>e.remove(),700);
}

function useSkill(n){
if(cool[n-1]>0)return;
if(n==1)enemyHP-=60;
if(n==2)hp=Math.min(100,hp+30);
if(n==3){
for(let r=0;r<R;r++)for(let c=0;c<C;c++)
if(board[r][c]==enemy.reflect)board[r][c]=enemy.weak;
}
cool[n-1]=[3,5,6][n-1];
update();
}

function update(){
document.getElementById("hp").style.width=Math.max(hp,0)+"%";
document.getElementById("enemy").style.width=Math.max(enemyHP/enemy.hp*100,0)+"%";
document.getElementById("stage").textContent="STAGE "+stage;
document.getElementById("s1").textContent="SKILL1("+cool[0]+")";
document.getElementById("s2").textContent="SKILL2("+cool[1]+")";
document.getElementById("s3").textContent="SKILL3("+cool[2]+")";
cool=cool.map(c=>Math.max(0,c-1));
if(enemyHP<=0){stage++;newEnemy();}
}

function save(){
localStorage.setItem("puzzleSave",JSON.stringify({hp,stage,enemyHP}));
}
function loadGame(){
let d=JSON.parse(localStorage.getItem("puzzleSave")||"null");
if(!d)return alert("セーブなし");
hp=d.hp;stage=d.stage;enemyHP=d.enemyHP;
document.getElementById("menu").style.display="none";
makeBoard();update();
}
function clearSave(){localStorage.removeItem("puzzleSave");alert("削除しました");}

function retry(){location.reload();}
</script>
</body>
</html>
