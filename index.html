<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PUZZLE BATTLE ULTIMATE+</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;background:#111;color:#fff;font-family:sans-serif;overflow:hidden}
#top{display:flex;justify-content:space-between;padding:6px;background:#222}
.bar{width:110px;height:10px;background:#333;border-radius:10px;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(to right,#0f0,#6f6)}
#enemyBar>div{background:linear-gradient(to right,#f33,#a00)}

#board{
 width:95vw;max-width:420px;height:360px;
 margin:auto;display:grid;
 grid-template-columns:repeat(6,1fr);
 grid-template-rows:repeat(5,1fr);
 gap:4px;
}
.orb{
 border-radius:50%;
 display:flex;align-items:center;justify-content:center;
 font-size:24px;
 cursor:pointer;
}
.fire{background:#ff6666}
.water{background:#4fa3ff}
.wood{background:#44cc77}
.light{background:#ffe066}
.dark{background:#8c6cff}

#combo{position:absolute;top:60px;width:100%;text-align:center;font-size:36px;color:gold}
#turnText{position:fixed;top:40%;width:100%;text-align:center;font-size:42px}

.effect{
 position:fixed;inset:0;pointer-events:none;
 animation:fade .6s forwards;
}
.absorbFx{
 background:radial-gradient(circle at center, #00ffaa99 0%, #000 70%);
}
.comboFx{
 position:fixed;inset:0;pointer-events:none;
 z-index:60;
 animation:fadeCombo .5s forwards;
}
.combo1{background:radial-gradient(circle,#fff5,transparent 60%)}
.combo2{background:radial-gradient(circle,#ffd70099,transparent 70%)}
.combo3{background:radial-gradient(circle,#ff5500aa,transparent 70%)}
.combo4{background:linear-gradient(45deg,#ff0a,#f0f,#0ff,#ff0a)}
@keyframes fade{from{opacity:1}to{opacity:0}}
@keyframes fadeCombo{from{opacity:1}to{opacity:0}}

#skills{text-align:center;margin:6px;}
button{padding:8px 14px;border-radius:20px;border:none;background:#333;color:#fff;margin:4px}

#result{
 position:fixed;inset:0;background:rgba(0,0,0,.9);
 display:none;flex-direction:column;justify-content:center;align-items:center;
}
.rank{font-size:64px;color:gold;text-shadow:0 0 20px gold}
</style>
</head>
<body>

<div id="top">
 <div>HP<div class="bar"><div id="hp"></div></div></div>
 <div>STAGE <span id="stage">1</span></div>
 <div>ENEMY<div class="bar" id="enemyBar"><div id="enemy"></div></div></div>
</div>

<div id="combo"></div>
<div id="board"></div>

<div id="skills">
 <button onclick="useHeal()">‚ù§Ô∏è ÂõûÂæ©</button>
 <button onclick="useBomb()">üí• „Éú„É†</button>
 <button onclick="useBoost()">‚ö° Âº∑Âåñ</button>
</div>

<div id="result">
 <div class="rank" id="rankText"></div>
 <p id="resultInfo"></p>
 <button onclick="location.reload()">RETRY</button>
</div>

<script>
const ROW=5,COL=6;
const colors=["fire","water","wood","light","dark"];
const weakness={fire:"wood",wood:"water",water:"fire",light:"dark",dark:"light"};

let board=[],stage=1;
let playerHP=100,enemyHP=100;
let combo=0,maxCombo=0,score=0;
let difficulty="normal";
let boostNext=false;

let cdHeal=0,cdBomb=0,cdBoost=0;

function rand(){return colors[Math.floor(Math.random()*5)]}
function init(){
 board=[...Array(ROW)].map(()=>Array(COL).fill().map(rand));
 newEnemy();
 draw();
 updateUI();
}

function newEnemy(){
 enemyHP=120+stage*40;
 enemyAttr=colors[Math.floor(Math.random()*5)];
}

function draw(){
 const b=document.getElementById("board");
 b.innerHTML="";
 for(let r=0;r<ROW;r++)for(let c=0;c<COL;c++){
  let d=document.createElement("div");
  d.className="orb "+board[r][c];
  d.dataset.r=r; d.dataset.c=c;
  b.appendChild(d);
 }
}

let last=null;
document.addEventListener("pointerdown",e=>{
 if(!e.target.classList.contains("orb"))return;
 last={r:+e.target.dataset.r,c:+e.target.dataset.c};
});
document.addEventListener("pointermove",e=>{
 if(!last)return;
 let t=document.elementFromPoint(e.clientX,e.clientY);
 if(!t||!t.classList.contains("orb"))return;
 let r=+t.dataset.r,c=+t.dataset.c;
 if(Math.abs(r-last.r)+Math.abs(c-last.c)==1){
  [board[r][c],board[last.r][last.c]]=[board[last.r][last.c],board[r][c]];
  last={r,c}; draw();
 }
});
document.addEventListener("pointerup",()=>{last=null;check();});

function check(){
 let del=[];
 for(let r=0;r<ROW;r++)for(let c=0;c<COL-2;c++)
  if(board[r][c]==board[r][c+1]&&board[r][c]==board[r][c+2])
   del.push([r,c],[r,c+1],[r,c+2]);
 for(let c=0;c<COL;c++)for(let r=0;r<ROW-2;r++)
  if(board[r][c]==board[r+1][c]&&board[r][c]==board[r+2][c])
   del.push([r,c],[r+1,c],[r+2,c]);

 if(!del.length){combo=0;updateUI();return;}

 combo++; maxCombo=Math.max(maxCombo,combo);
 let base=del.length*5;
 let color=board[del[0][0]][del[0][1]];
 let dmg=base;

 // Âê∏ÂèéÂà§ÂÆö
 if(color===enemyAttr){
  enemyHP+=base;
  showAbsorb();
  dmg=0;
 }

 // Âº±ÁÇπÂà§ÂÆö
 if(weakness[color]===enemyAttr) dmg*=1.5;

 // „Éñ„Éº„Çπ„ÉàÂà§ÂÆö
 if(boostNext){dmg*=2; boostNext=false;}

 enemyHP-=dmg;
 score+=Math.floor(dmg*10);

 del.forEach(p=>board[p[0]][p[1]]=null);
 fall();
 comboEffect(combo);
 updateUI();

 if(enemyHP<=0){stage++;newEnemy();}
 setTimeout(check,120);
}

function showAbsorb(){
 let e=document.createElement("div");
 e.className="effect absorbFx";
 document.body.appendChild(e);
 setTimeout(()=>e.remove(),600);
}

function comboEffect(c){
 let e=document.createElement("div");
 e.className="comboFx";
 if(c>=8) e.classList.add("combo4");
 else if(c>=5) e.classList.add("combo3");
 else if(c>=3) e.classList.add("combo2");
 else e.classList.add("combo1");
 document.body.appendChild(e);
 setTimeout(()=>e.remove(),500);
}

function fall(){
 for(let c=0;c<COL;c++)
  for(let r=ROW-1;r>=0;r--)
   if(!board[r][c]){
    for(let rr=r-1;rr>=0;rr--)
     if(board[rr][c]){board[r][c]=board[rr][c];board[rr][c]=null;break;}
    if(!board[r][c]) board[r][c]=rand();
   }
 draw();
}

function updateUI(){
 document.getElementById("hp").style.width=playerHP+"%";
 document.getElementById("enemy").style.width=enemyHP+"%";
 document.getElementById("stage").textContent=stage;
 document.getElementById("combo").textContent=combo>1?combo+" COMBO!":"";
}

// „Çπ„Ç≠„É´
function useHeal(){if(cdHeal>0)return; playerHP=Math.min(100,playerHP+30); cdHeal=3;}
function useBomb(){if(cdBomb>0)return; for(let i=0;i<8;i++){let r=Math.floor(Math.random()*ROW); let c=Math.floor(Math.random()*COL); board[r][c]=null;} fall(); cdBomb=4;}
function useBoost(){if(cdBoost>0)return; boostNext=true; cdBoost=5;}

setInterval(()=>{
 if(cdHeal>0) cdHeal--;
 if(cdBomb>0) cdBomb--;
 if(cdBoost>0) cdBoost--;
},1000);

// „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÂà§ÂÆö
function endGame(){
 let rank="D";
 if(score>=120000) rank="S";
 else if(score>=80000) rank="A";
 else if(score>=50000) rank="B";
 else if(score>=20000) rank="C";

 document.getElementById("rankText").textContent=rank;
 document.getElementById("resultInfo").textContent=
 `SCORE: ${score}\nMAX COMBO: ${maxCombo}\nSTAGE: ${stage}`;
 document.getElementById("result").style.display="flex";
}

// Ëá™ÂãïÁµÇ‰∫Ü‰æãÔºöHP0„Åß„Ç≤„Éº„É†ÁµÇ‰∫Ü
setInterval(()=>{
 if(playerHP<=0) endGame();
},500);

// ÂàùÊúüÂåñ
window.onload=()=>{init();};
</script>
</body>
</html>
