<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PUZZLE BATTLE ULTIMATE - LUNATIC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;touch-action:none}
body{margin:0;background:#111;color:#fff;font-family:sans-serif}
#top{display:flex;justify-content:space-between;padding:6px;background:#222;font-size:14px}
.bar{width:110px;height:10px;background:#333;border-radius:10px;overflow:hidden}
.bar>div{height:100%;transition:.2s}
#hp{background:linear-gradient(to right,#0f0,#6f6)}
#enemy{background:linear-gradient(to right,#f33,#a00)}

#board{width:95vw;max-width:420px;height:360px;margin:auto;
display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(5,1fr);gap:4px}

.orb{border-radius:50%;box-shadow:inset -4px -4px 6px rgba(0,0,0,.4),inset 3px 3px 6px rgba(255,255,255,.3)}
.fire{background:#f55}
.water{background:#59f}
.wood{background:#5f5}
.light{background:#ff5}
.dark{background:#b5f}

.effect{position:fixed;top:40%;width:100%;text-align:center;font-size:42px;font-weight:bold;pointer-events:none;opacity:0}
.effect.show{opacity:1}

#skillBar{text-align:center;margin:4px}
button{padding:6px 10px;border-radius:12px;border:none;background:#333;color:#fff;margin:2px}

#enemyInfo{text-align:center;font-size:14px;padding:4px;background:#111}

#result{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;text-align:center}
</style>
</head>
<body>

<div id="top">
  <div>HP<div class="bar"><div id="hp"></div></div></div>
  <div>STAGE <span id="stage">1</span></div>
  <div>ENEMY<div class="bar"><div id="enemy"></div></div></div>
</div>

<div id="enemyInfo"></div>

<div id="skillBar">
  <button onclick="useSkill('heal')">üíöHEAL</button>
  <button onclick="useSkill('break')">üí•BREAK</button>
  <button onclick="useSkill('time')">‚è±STOP</button>
</div>

<div id="board"></div>
<div id="effect" class="effect"></div>

<div id="result">
  <div>
    <h1 id="resultText"></h1>
    <p id="scoreText"></p>
    <button onclick="location.reload()">RETRY</button>
  </div>
</div>

<script>
/* ===== Âü∫Êú¨Ë®≠ÂÆö ===== */
const ROW=5,COL=6;
const colors=["fire","water","wood","light","dark"];
const difficulty="lunatic"; // easy / normal / hard / lunatic

const diffMul={
 easy:{hp:0.8,atk:0.7},
 normal:{hp:1,atk:1},
 hard:{hp:1.5,atk:1.3},
 lunatic:{hp:3,atk:2}
};

const affinity={
 fire:{weak:"water",null:"wood",absorb:"fire",reflect:"light"},
 water:{weak:"wood",null:"fire",absorb:"water",reflect:"dark"},
 wood:{weak:"fire",null:"water",absorb:"wood",reflect:"light"},
 light:{weak:"dark",null:null,absorb:null,reflect:"dark"},
 dark:{weak:"light",null:null,absorb:null,reflect:"light"}
};

let board=[],stage=1,playerHP=100,enemyHP=100;
let enemyAttr="fire",score=0,combo=0;
let enemyShield=false,enemyPoison=0,skillLock=0;

/* ÂàùÊúüÂåñ */
function init(){
  for(let r=0;r<ROW;r++){
    board[r]=[];
    for(let c=0;c<COL;c++) board[r][c]=colors[Math.floor(Math.random()*5)];
  }
  spawnEnemy();
  draw();updateUI();
}

/* ÊïµÁîüÊàê */
function spawnEnemy(){
  enemyAttr=colors[Math.floor(Math.random()*5)];
  enemyHP=120*diffMul[difficulty]+stage*40;
}

/* Ë°®Á§∫ */
function draw(){
  const b=document.getElementById("board");
  b.innerHTML="";
  for(let r=0;r<ROW;r++)for(let c=0;c<COL;c++){
    let d=document.createElement("div");
    d.className="orb "+board[r][c];
    d.dataset.r=r;d.dataset.c=c;
    b.appendChild(d);
  }
  document.getElementById("enemyInfo").innerHTML=
    `Â±ûÊÄß: <b>${enemyAttr.toUpperCase()}</b>„ÄÄ
     Âº±ÁÇπ:${affinity[enemyAttr].weak || "-"}„ÄÄ
     Âê∏Âèé:${affinity[enemyAttr].absorb || "-"}„ÄÄ
     ÂèçÂ∞Ñ:${affinity[enemyAttr].reflect || "-"}`;
}

/* ÂÖ•Âäõ */
let drag=false,last=null;
document.addEventListener("pointerdown",e=>{
 if(!e.target.classList.contains("orb"))return;
 drag=true; last={r:+e.target.dataset.r,c:+e.target.dataset.c};
});
document.addEventListener("pointermove",e=>{
 if(!drag)return;
 const t=document.elementFromPoint(e.clientX,e.clientY);
 if(!t||!t.classList.contains("orb"))return;
 let r=+t.dataset.r,c=+t.dataset.c;
 if(Math.abs(r-last.r)+Math.abs(c-last.c)==1){
  [board[r][c],board[last.r][last.c]]=[board[last.r][last.c],board[r][c]];
  last={r,c}; draw();
 }
});
document.addEventListener("pointerup",()=>{drag=false;check();});

/* Âà§ÂÆö */
function check(){
 let del=[];
 for(let r=0;r<ROW;r++)for(let c=0;c<COL-2;c++)
  if(board[r][c]==board[r][c+1]&&board[r][c]==board[r][c+2])
   del.push([r,c],[r,c+1],[r,c+2]);

 for(let c=0;c<COL;c++)for(let r=0;r<ROW-2;r++)
  if(board[r][c]==board[r+1][c]&&board[r][c]==board[r+2][c])
   del.push([r,c],[r+1,c],[r+2,c]);

 if(!del.length){enemyTurn();return;}

 let dmg=0;
 del.forEach(p=>{
  let col=board[p[0]][p[1]];
  let aff=affinity[enemyAttr];

  if(col===aff.absorb){playerHP+=5;showEffect("ABSORB");}
  else if(col===aff.null){showEffect("NULL");}
  else{
    let base=10;
    if(col===aff.weak){base*=2;showEffect("WEAK");}
    if(col===aff.reflect){playerHP-=5;showEffect("REFLECT");}
    dmg+=base;
  }
  board[p[0]][p[1]]=null;
 });

 if(enemyShield) dmg*=0.5;
 enemyHP-=dmg;
 score+=dmg;

 fall(); updateUI();
}

/* ËêΩ‰∏ã */
function fall(){
 for(let c=0;c<COL;c++){
  for(let r=ROW-1;r>=0;r--){
   if(!board[r][c]){
    for(let rr=r-1;rr>=0;rr--){
     if(board[rr][c]){
      board[r][c]=board[rr][c];
      board[rr][c]=null;
      break;
     }
    }
    if(!board[r][c]) board[r][c]=colors[Math.floor(Math.random()*5)];
   }
  }
 }
 draw();
}

/* Êïµ„Çø„Éº„É≥ */
function enemyTurn(){
 if(Math.random()<0.6){ // „Çπ„Ç≠„É´Áô∫ÂãïÁéá
  let r=Math.random();
  if(r<0.3){ enemyShield=true; showEffect("BARRIER"); }
  else if(r<0.6){ playerHP-=20; showEffect("STRIKE"); }
  else { skillLock=2; showEffect("SEAL"); }
 }
 playerHP-=10*diffMul[difficulty];
 enemyShield=false;
 updateUI();
}

/* „Çπ„Ç≠„É´ */
function useSkill(type){
 if(skillLock>0)return;
 if(type==="heal") playerHP=Math.min(100,playerHP+30);
 if(type==="break") enemyHP-=40;
 if(type==="time"){} // ÁúÅÁï•ÔºàÂÅúÊ≠¢Ôºâ
}

/* Ë°®Á§∫ */
function updateUI(){
 document.getElementById("hp").style.width=playerHP+"%";
 document.getElementById("enemy").style.width=enemyHP+"%";
 document.getElementById("stage").textContent=stage;

 if(playerHP<=0){
  document.getElementById("result").style.display="flex";
  document.getElementById("resultText").textContent="GAME OVER";
  document.getElementById("scoreText").textContent="SCORE: "+score;
 }
 if(enemyHP<=0){
  stage++;
  spawnEnemy();
 }
}

/* „Ç®„Éï„Çß„ÇØ„Éà */
function showEffect(t){
 const e=document.getElementById("effect");
 e.textContent=t;
 e.classList.add("show");
 setTimeout(()=>e.classList.remove("show"),400);
}

init();
</script>
</body>
</html>
