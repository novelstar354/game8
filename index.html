<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PUZZLE BATTLE ULTIMATE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;touch-action:none;}
body{margin:0;background:#111;color:#fff;font-family:sans-serif;}
#top{display:flex;justify-content:space-between;padding:6px;background:#222;font-size:14px}
.bar{width:110px;height:10px;background:#333;border-radius:10px;overflow:hidden}
.bar>div{height:100%;background:linear-gradient(to right,#0f0,#6f6)}
#enemyBar>div{background:linear-gradient(to right,#f33,#a00)}

#board{
  width:95vw;max-width:420px;height:360px;
  margin:auto;display:grid;
  grid-template-columns:repeat(6,1fr);
  grid-template-rows:repeat(5,1fr);
  gap:4px;
}
.orb{border-radius:50%;box-shadow:inset -4px -4px 6px rgba(0,0,0,.4),inset 3px 3px 6px rgba(255,255,255,.3);}
.fire{background:#f55}
.water{background:#59f}
.wood{background:#5f5}
.light{background:#ff5}
.dark{background:#b5f}

#enemyInfo{text-align:center;font-size:13px;margin:6px 0}

#combo{position:absolute;top:60px;width:100%;text-align:center;font-size:36px;color:gold;opacity:0}
#turnText{position:fixed;top:40%;width:100%;text-align:center;font-size:42px;opacity:0;font-weight:bold}

#skillBar button{
 margin:4px;padding:8px 14px;border-radius:14px;
 border:none;background:#333;color:#fff;
}

#result{
 position:fixed;inset:0;
 background:rgba(0,0,0,.85);
 display:none;justify-content:center;align-items:center;
}
</style>
</head>
<body>

<div id="top">
 <div>HP<div class="bar"><div id="hp"></div></div></div>
 <div>STAGE <span id="stage">1</span></div>
 <div>ENEMY<div class="bar" id="enemyBar"><div id="enemy"></div></div></div>
</div>

<div style="text-align:center;margin:4px">
 DIFFICULTY:
 <select id="difficultySelect" onchange="changeDifficulty()">
  <option value="easy">EASY</option>
  <option value="normal" selected>NORMAL</option>
  <option value="hard">HARD</option>
  <option value="lunatic">LUNATIC</option>
 </select>
</div>

<div id="enemyInfo"></div>
<div id="timer" style="text-align:center">TIME: 15</div>
<div id="combo"></div>
<div id="turnText"></div>

<div id="board"></div>

<div id="skillBar" style="text-align:center">
 <button id="healBtn" onclick="useSkill('heal')">üíö HEAL</button>
 <button id="breakBtn" onclick="useSkill('break')">üí• BREAK</button>
 <button id="timeBtn" onclick="useSkill('time')">‚è± TIME</button>
</div>

<div style="text-align:center">
 <button onclick="saveGame()">üíæ SAVE</button>
 <button onclick="loadGame()">üìÇ LOAD</button>
 <button onclick="deleteSave()">üóë RESET</button>
</div>

<div id="result">
 <div>
  <h2 id="resultText"></h2>
  <button onclick="location.reload()">RETRY</button>
 </div>
</div>

<script>
const ROW=5,COL=6;
const colors=["fire","water","wood","light","dark"];
const SAVE_KEY="PUZZLE_FULL_SAVE";

let board=[],stage=1,playerHP=100,enemyHP=100;
let timer=15,timerOn=false,combo=0;
let difficulty="normal",enemyAttr="fire";

const skills={
 heal:{cool:5,now:0},
 break:{cool:4,now:0},
 time:{cool:3,now:0}
};

const difficultyData={
 easy:{weak:2.5,absorb:false,null:false,reflect:false},
 normal:{weak:2,absorb:false,null:false,reflect:true},
 hard:{weak:2,absorb:true,null:true,reflect:true},
 lunatic:{weak:3,absorb:true,null:true,reflect:true}
};

const affinity={
 fire:{weak:"water",null:"wood",absorb:"fire",reflect:"light"},
 water:{weak:"wood",null:"fire",absorb:"water",reflect:"dark"},
 wood:{weak:"fire",null:"water",absorb:"wood",reflect:"light"},
 light:{weak:"dark",null:null,absorb:null,reflect:"dark"},
 dark:{weak:"light",null:null,absorb:null,reflect:"light"}
};

/* ---------- ÂàùÊúüÂåñ ---------- */
function init(){
 for(let r=0;r<ROW;r++){
  board[r]=[];
  for(let c=0;c<COL;c++) board[r][c]=rand();
 }
 newEnemy();
 draw();
 updateUI();
 updateEnemyInfo();
}

/* ---------- Êïµ ---------- */
function newEnemy(){
 enemyHP=100+stage*25;
 enemyAttr=colors[Math.floor(Math.random()*colors.length)];
 updateEnemyInfo();
}

/* ---------- Ë°®Á§∫ ---------- */
function draw(){
 const b=document.getElementById("board");
 b.innerHTML="";
 for(let r=0;r<ROW;r++)for(let c=0;c<COL;c++){
  const d=document.createElement("div");
  d.className="orb "+board[r][c];
  d.dataset.r=r;d.dataset.c=c;
  b.appendChild(d);
 }
}

/* ---------- ÂÖ•Âäõ ---------- */
let drag=false,last=null;
document.addEventListener("pointerdown",e=>{
 if(!e.target.classList.contains("orb"))return;
 drag=true;
 last={r:+e.target.dataset.r,c:+e.target.dataset.c};
 if(!timerOn) startTurn();
});
document.addEventListener("pointermove",e=>{
 if(!drag)return;
 const t=document.elementFromPoint(e.clientX,e.clientY);
 if(!t||!t.classList.contains("orb"))return;
 let r=+t.dataset.r,c=+t.dataset.c;
 if(Math.abs(r-last.r)+Math.abs(c-last.c)==1){
  [board[r][c],board[last.r][last.c]]=[board[last.r][last.c],board[r][c]];
  last={r,c}; draw();
 }
});
document.addEventListener("pointerup",()=>{drag=false;check();});

/* ---------- „Çø„Éº„É≥ ---------- */
function startTurn(){
 timer=15; timerOn=true;
 for(let k in skills) if(skills[k].now>0) skills[k].now--;
 updateSkillUI();
 showTurn("YOUR TURN");
 tick();
}

function tick(){
 const t=setInterval(()=>{
  timer--;
  document.getElementById("timer").textContent="TIME: "+timer;
  if(timer<=0){clearInterval(t);enemyTurn();}
 },1000);
}

/* ---------- Âà§ÂÆö ---------- */
function check(){
 let del=[];
 for(let r=0;r<ROW;r++)for(let c=0;c<COL-2;c++)
  if(board[r][c]==board[r][c+1]&&board[r][c]==board[r][c+2])
   del.push([r,c],[r,c+1],[r,c+2]);

 for(let c=0;c<COL;c++)for(let r=0;r<ROW-2;r++)
  if(board[r][c]==board[r+1][c]&&board[r][c]==board[r+2][c])
   del.push([r,c],[r+1,c],[r+2,c]);

 if(!del.length){combo=0;return;}

 let dmg=0;
 del.forEach(p=>{
  dmg+=calcDamage(board[p[0]][p[1]]);
  board[p[0]][p[1]]=null;
 });

 enemyHP-=dmg;
 fall();
 updateUI();
 if(enemyHP<=0){stage++;newEnemy();}
 setTimeout(check,150);
}

/* ---------- „ÉÄ„É°„Éº„Ç∏ ---------- */
function calcDamage(col){
 const rule=difficultyData[difficulty];
 const a=affinity[enemyAttr];
 if(rule.absorb && col===a.absorb){playerHP+=5;return 0;}
 if(rule.null && col===a.null)return 0;
 if(rule.reflect && col===a.reflect){playerHP-=5;return 0;}
 if(col===a.weak)return 10*rule.weak;
 return 10;
}

/* ---------- ËêΩ‰∏ã ---------- */
function fall(){
 for(let c=0;c<COL;c++){
  for(let r=ROW-1;r>=0;r--){
   if(!board[r][c]){
    for(let rr=r-1;rr>=0;rr--){
     if(board[rr][c]){board[r][c]=board[rr][c];board[rr][c]=null;break;}
    }
    if(!board[r][c]) board[r][c]=rand();
   }
  }
 }
 draw();
}

/* ---------- „Çπ„Ç≠„É´ ---------- */
function useSkill(t){
 if(skills[t].now>0)return;
 if(t==="heal") playerHP=Math.min(100,playerHP+30);
 if(t==="break") enemyHP-=40;
 if(t==="time") timer+=5;
 skills[t].now=skills[t].cool;
 updateSkillUI();
}

/* ---------- Êïµ„Çø„Éº„É≥ ---------- */
function enemyTurn(){
 showTurn("ENEMY TURN");
 setTimeout(()=>{
  let dmg=difficulty==="lunatic"?30:20;
  playerHP-=dmg;
  if(playerHP<=0) gameOver();
  timerOn=false;
  saveGame();
 },700);
}

/* ---------- UI ---------- */
function updateUI(){
 document.getElementById("hp").style.width=playerHP+"%";
 document.getElementById("enemy").style.width=enemyHP+"%";
 document.getElementById("stage").textContent=stage;
}
function updateSkillUI(){
 for(let k in skills){
  const b=document.getElementById(k+"Btn");
  b.textContent=skills[k].now>0?`${k.toUpperCase()}(${skills[k].now})`:k.toUpperCase();
  b.style.opacity=skills[k].now>0?0.5:1;
 }
}
function updateEnemyInfo(){
 const a=affinity[enemyAttr];
 const rule=difficultyData[difficulty];
 let html=`ENEMY: <b>${enemyAttr.toUpperCase()}</b><br>`;
 if(a.weak) html+=`WEAK: ${a.weak}<br>`;
 if(rule.absorb && a.absorb) html+=`ABSORB: ${a.absorb}<br>`;
 if(rule.null && a.null) html+=`NULL: ${a.null}<br>`;
 if(rule.reflect && a.reflect) html+=`REFLECT: ${a.reflect}<br>`;
 document.getElementById("enemyInfo").innerHTML=html;
}

function showTurn(t){
 const e=document.getElementById("turnText");
 e.textContent=t;
 e.style.opacity=1;
 setTimeout(()=>e.style.opacity=0,600);
}

/* ---------- „Çª„Éº„Éñ ---------- */
function saveGame(){
 localStorage.setItem(SAVE_KEY,JSON.stringify({
  board,stage,playerHP,enemyHP,enemyAttr,skills,timer,difficulty
 }));
}
function loadGame(){
 const d=JSON.parse(localStorage.getItem(SAVE_KEY));
 if(!d)return;
 board=d.board;stage=d.stage;playerHP=d.playerHP;
 enemyHP=d.enemyHP;enemyAttr=d.enemyAttr;
 skills=d.skills;timer=d.timer;difficulty=d.difficulty;
 document.getElementById("difficultySelect").value=difficulty;
 draw();updateUI();updateEnemyInfo();updateSkillUI();
}

/* ---------- „Åù„ÅÆ‰ªñ ---------- */
function deleteSave(){localStorage.removeItem(SAVE_KEY);location.reload();}
function rand(){return colors[Math.floor(Math.random()*colors.length)]}
function gameOver(){
 document.getElementById("result").style.display="flex";
 document.getElementById("resultText").textContent="GAME OVER";
}
function changeDifficulty(){
 difficulty=document.getElementById("difficultySelect").value;
 updateEnemyInfo();
 saveGame();
}

/* Ëµ∑Âãï */
loadGame()||init();
</script>
</body>
</html>
